name: Update Pokemon Data

on:
  schedule:
    # 毎月1日の午前2時（UTC）に実行
    - cron: '0 2 1 * *'
  workflow_dispatch:
    # 手動実行も可能

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # タイムアウトを10分に設定（API呼び出しのため）
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Fetch Pokemon data from PokéAPI
        run: |
          echo "Starting Pokemon data fetch from PokéAPI..."
          python3 .github/scripts/fetch-pokemon-data.py names.json
          echo "Data fetch completed successfully"

      - name: Calculate SHA256 and get entry count
        run: |
          sha256sum names.json > names.json.sha256
          echo "SHA256_HASH=$(cut -d' ' -f1 names.json.sha256)" >> $GITHUB_ENV

          # JSONからエントリ数を取得
          ENTRY_COUNT=$(python3 -c "import json; print(json.load(open('names.json'))['count'])")
          echo "ENTRY_COUNT=$ENTRY_COUNT" >> $GITHUB_ENV

          # 生成日時を取得
          GENERATED_AT=$(python3 -c "import json; print(json.load(open('names.json'))['generated_at'])")
          echo "GENERATED_AT=$GENERATED_AT" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: data-${{ github.run_number }}
          name: Pokemon Data Update ${{ github.run_number }}
          body: |
            Pokemon names data update from PokéAPI

            **Entry count:** ${{ env.ENTRY_COUNT }}
            **Generated at:** ${{ env.GENERATED_AT }}
            **SHA256:** ${{ env.SHA256_HASH }}

            Usage: `poke-lookup update`
          files: |
            names.json
            names.json.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}